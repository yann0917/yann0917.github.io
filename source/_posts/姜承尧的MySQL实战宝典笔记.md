---
title: 姜承尧的MySQL实战宝典笔记
tags:
  - MySQL
categories: MySQL
abbrlink: 53009
date: 2021-05-29 14:02:43
---

> 01~07 表设计篇
>
> 08~14 索引调优篇
>
> 15~21 高可用架构篇
>
> 22~28 分布式架构篇
>
> 29~36 终极实战篇

## 01数字类型：避免自增踩坑

* 不推荐使用整型类型的属性 Unsigned，若非要使用，参数 sql_mode 务必额外添加上选项 `NO_UNSIGNED_SUBTRACTION`；

* 自增整型类型做主键，**务必使用类型 BIGINT**，而非 INT，后期表结构调整代价巨大；

* MySQL 8.0 版本前，**自增整型会有回溯问题，做业务开发的你一定要了解这个问题**；

* 当达到自增整型类型的上限值时，再次自增插入，MySQL 数据库会报重复错误；

* 不要再使用浮点类型 Float、Double，MySQL 后续版本将不再支持上述两种类型；

* 账户余额字段，设计是用`整型类型`，而不是 `DECIMAL` 类型，这样性能更好，存储更紧凑

## 02字符串类型：不能忽略的 COLLATION

* CHAR 和 VARCHAR 虽然分别用于存储定长和变长字符，但对于变长字符集（如 GBK、UTF8MB4），**其本质是一样的，都是变长，设计时完全可以用 VARCHAR 替代 CHAR**；

* 推荐 MySQL 字符集默认设置为 `UTF8MB4`，可以用于存储 emoji 等扩展字符；

* 排序规则很重要，用于字符的比较和排序，但大部分场景不需要用区分大小写的排序规则；

* 修改表中已有列的字符集，使用命令 ALTER TABLE ... CONVERT TO .... eg: `ALTER TABLE emoji_test CONVERT TO CHARSET utf8mb4;`；

* 用户性别，运行状态等有限值的列，MySQL 8.0.16 版本直接使用 CHECK 约束机制，之前的版本可使用 ENUM 枚举字符串类型，外加 SQL_MODE 的严格模式；

* 业务隐私信息，如密码、手机、信用卡等信息，需要加密。切记简单的MD5算法是可以进行暴力破解，并不安全，推荐使用**动态盐+动态加密算法**进行隐私数据的存储

## 03日期类型：TIMESTAMP 可能是巨坑

* MySQL 5.6 版本开始 DATETIME 和 TIMESTAMP 精度支持到毫秒；

* DATETIME 占用 8 个字节，TIMESTAMP 占用 4 个字节，DATETIME(6) 依然占用 8 个字节，TIMESTAMP(6) 占用 7 个字节；

* TIMESTAMP 日期存储的上限为 `2038-01-19 03:14:07`，业务用 TIMESTAMP 存在风险；

* 使用 TIMESTAMP 必须显式地设置时区，不要使用默认系统时区，否则存在性能问题，推荐在配置文件中设置参数 `time_zone = '+08:00'`；

* 推荐日期类型使用 DATETIME，而不是 TIMESTAMP 和 INT 类型；

* 表结构设计时，每个核心业务表，推荐设计一个 last_modify_date 的字段，用以记录每条记录的最后修改时间

## 04非结构存储：用好 JSON 这张牌

* JSON 类型是 MySQL 5.7 版本新增的数据类型，使用 JSON 数据类型，推荐用 MySQL 8.0.17 以上的版本，性能更好，同时也支持 Multi-Valued Indexes；

* JSON 数据类型的好处是无须预先定义列，数据本身就具有很好的描述性；

* 不要将有明显关系型的数据用 JSON 存储，如用户余额、用户姓名、用户身份证等，这些都是每个用户必须包含的数据；

* JSON 数据类型推荐使用在不经常更新的静态数据存储。

## 05表结构设计：忘记范式准则

在 MySQL 海量并发的工程实践上，表结构设计应遵循这样几个规范：

* 每张表一定要有一个主键；

* 自增主键只推荐用在非核心业务表，甚至应避免使用；

* 核心业务表推荐使用 UUID 或业务自定义主键；

* 一份数据应尽可能保留一份，通过主键关联进行查询，避免冗余数据；

* 在一些场景下，可以通过 JSON 数据类型进行反范式设计，提升存储效率；


## 06表压缩：不仅仅是空间压缩

* MySQL 中的压缩都是基于页的压缩；

* COMPRESS 页压缩适合用于性能要求不高的业务表，如日志、监控、告警表等；

* COMPRESS 页压缩内存缓冲池存在压缩和解压的两个页，会严重影响性能；

* 对存储有压缩需求，又希望性能不要有明显退化，推荐使用 TPC 压缩；

* 通过 ALTER TABLE 启用 TPC 压缩后，还需要执行命令 OPTIMIZE TABLE 才能立即完成空间的压缩。

## 07表的访问设计：你该选择 SQL 还是 NoSQL？

* `INSTALL PLUGIN daemon_memcached soname "libmemcached.so";` MySQL 5.6 版本开始支持通过插件 Memcached Plugin，以 KV 方式访问表，这时可以将 MySQL视作一个 Memcached KV 数据库。
* `SHOW VARIABLES LIEK '%mysqlx%';` 查看有关 X Plugin 的配置

---

## 08索引：排序的艺术

* 索引是加快查询的一种数据结构，其原理是插入时对数据排序，缺点是会影响插入的性能；

* MySQL 当前支持 B+树索引、全文索引、R 树索引；

* B+ 树索引的高度通常为 3~4 层，高度为 4 的 B+ 树能存放 50 亿左右的数据；

* 由于 B+ 树的高度不高，查询效率极高，50 亿的数据也只需要插叙 4 次 I/O；

* MySQL 单表的索引没有个数限制，业务查询有具体需要，创建即可，不要迷信个数限制；

* 可以通过表 sys.schema_unused_indexes 和索引不可见特性，删除无用的索引。

## 09索引组织表：万物皆索引

* 索引组织表主键是聚集索引，索引的叶子节点存放表中一整行完整记录；

* 除主键索引外的索引都是二级索引，索引的叶子节点存放的是（索引键值，主键值）；

* 由于二级索引不存放完整记录，因此需要通过主键值再进行一次回表才能定位到完整数据；

* 索引组织表对比堆表，在海量并发的OLTP业务中能有更好的性能表现；

* 每种不同数据，对二级索引的性能开销影响是不一样的；

* 有时通过函数索引可以快速解决线上SQL的性能问题；

* 虚拟列不占用实际存储空间，在虚拟列上创建索引本质就是函数索引。

## 10组合索引：用好，性能提升 10 倍！

组合索引也是一颗 B+ 树，只是索引的列由多个组成，组合索引既可以是主键索引，也可以是二级索引。通过今天的学习，我们可以归纳组合索引的三大优势：

覆盖多个查询条件，如（a，b）索引可以覆盖查询 a = ? 或者 a = ? and b = ?；

避免 SQL 的额外排序，提升 SQL 性能，如 WHERE a = ? ORDER BY b 这样的查询条件；

利用组合索引包含多个列的特性，可以实现索引覆盖技术，提升 SQL 的查询性能，用好索引覆盖技术，性能提升 10 倍不是难事。

## 11索引出错：请理解 CBO 的工作原理
## 12JOIN 连接：到底能不能写 JOIN？
## 13子查询：放心地使用子查询功能吧！
## 14分区表：哪些场景我不建议用分区表？


---


## 15MySQL 复制：最简单也最容易配置出错
## 16读写分离设计：复制延迟？其实是你用错了
## 17高可用设计：你怎么活用三大架构方案？
## 18金融级高可用架构：必不可少的数据核对
## 19高可用套件：选择这么多，你该如何选？
## 20InnoDB Cluster：改变历史的新产品
## 21数据库备份：备份文件也要检查！

---


## 22分布式数据库架构：彻底理解什么叫分布式数据库
## 23分布式数据库表结构设计：如何正确地将数据分片？
## 24分布式数据库索引设计：二级索引、全局索引的最佳设计实践
## 25分布式数据库架构选型：分库分表 or 中间件 ？
## 26分布式设计之禅：全链路的条带化设计
## 27分布式事务：我们到底要不要使用 2PC？

---


## 28MySQL 数据库开发规范
## 29如何优雅地删除生产环境中的大表？
## 30历史数据库系统：不可或缺的迁移系统


---
